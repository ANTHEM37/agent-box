# AI Agent Platform - 部署和测试指南

## 📋 目录
- [环境要求](#环境要求)
- [快速启动](#快速启动)
- [详细部署步骤](#详细部署步骤)
- [功能测试](#功能测试)
- [故障排除](#故障排除)
- [性能优化](#性能优化)

## 🔧 环境要求

### 基础环境
- **Java**: 17+
- **Node.js**: 18+
- **Docker**: 20.10+
- **Docker Compose**: 2.0+
- **Maven**: 3.8+
- **Git**: 2.30+

### 系统资源
- **内存**: 最少 8GB，推荐 16GB
- **存储**: 最少 20GB 可用空间
- **CPU**: 4核心以上

## 🚀 快速启动

### 1. 克隆项目
```bash
git clone <repository-url>
cd agent-box
```

### 2. 启动基础服务
```bash
# 启动数据库和中间件
docker-compose up -d postgres redis chroma minio rabbitmq

# 等待服务启动完成（约30秒）
docker-compose ps
```

### 3. 启动后端服务
```bash
cd backend

# 编译项目
mvn clean compile -DskipTests

# 启动应用
mvn spring-boot:run
```

### 4. 启动前端服务
```bash
cd frontend

# 安装依赖
npm install

# 启动开发服务器
npm run dev
```

### 5. 访问应用
- **前端**: http://localhost:3000
- **后端API**: http://localhost:8080/api
- **API文档**: http://localhost:8080/swagger-ui.html

## 📝 详细部署步骤

### 数据库初始化

1. **检查数据库连接**
```bash
docker exec -it agent-postgres psql -U agent_user -d agent_platform
```

2. **验证表结构**
```sql
\dt
-- 应该看到所有业务表
```

3. **初始化数据**
```sql
-- 创建管理员用户
INSERT INTO users (username, email, password, role, enabled) 
VALUES ('admin', 'admin@example.com', '$2a$10$...', 'ADMIN', true);
```

### 服务配置

1. **后端配置** (`backend/src/main/resources/application.yml`)
```yaml
server:
  port: 8080

spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/agent_platform
    username: agent_user
    password: agent_password
  
  redis:
    host: localhost
    port: 6379
    
langchain4j:
  open-ai:
    api-key: ${OPENAI_API_KEY:your-api-key}
    base-url: ${OPENAI_BASE_URL:https://api.openai.com/v1}
```

2. **前端配置** (`frontend/.env`)
```env
VITE_API_BASE_URL=http://localhost:8080/api
VITE_APP_TITLE=AI Agent Platform
```

### Docker 生产部署

1. **构建镜像**
```bash
# 后端镜像
cd backend
docker build -t agent-platform-backend .

# 前端镜像
cd frontend
docker build -t agent-platform-frontend .
```

2. **生产环境启动**
```bash
# 使用生产配置
docker-compose -f docker-compose.prod.yml up -d
```

## 🧪 功能测试

### 1. 用户认证测试

```bash
# 注册用户
curl -X POST http://localhost:8080/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "email": "test@example.com",
    "password": "password123"
  }'

# 用户登录
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "password123"
  }'
```

### 2. 知识库功能测试

```bash
# 创建知识库
curl -X POST http://localhost:8080/api/knowledge/bases \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "测试知识库",
    "description": "用于测试的知识库"
  }'

# 上传文档
curl -X POST http://localhost:8080/api/knowledge/documents \
  -H "Authorization: Bearer <token>" \
  -F "file=@test.pdf" \
  -F "knowledgeBaseId=1"
```

### 3. 工作流功能测试

```bash
# 创建工作流
curl -X POST http://localhost:8080/api/workflows \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "测试工作流",
    "description": "简单的测试工作流",
    "definition": {
      "nodes": [...],
      "edges": [...]
    }
  }'
```

### 4. MCP 服务测试

```bash
# 发布服务
curl -X POST http://localhost:8080/api/mcp/services \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "test-service",
    "displayName": "测试服务",
    "description": "用于测试的MCP服务",
    "dockerImage": "nginx:latest"
  }'
```

## 🔍 故障排除

### 常见问题

1. **数据库连接失败**
```bash
# 检查数据库状态
docker-compose ps postgres

# 查看数据库日志
docker-compose logs postgres

# 重启数据库
docker-compose restart postgres
```

2. **Redis 连接问题**
```bash
# 测试 Redis 连接
docker exec -it agent-redis redis-cli ping

# 清空 Redis 缓存
docker exec -it agent-redis redis-cli flushall
```

3. **向量数据库问题**
```bash
# 检查 Chroma 状态
curl http://localhost:8000/api/v1/heartbeat

# 重启 Chroma
docker-compose restart chroma
```

4. **后端启动失败**
```bash
# 检查 Java 版本
java -version

# 清理并重新编译
mvn clean compile -DskipTests

# 查看详细错误
mvn spring-boot:run -X
```

5. **前端编译错误**
```bash
# 清理依赖
rm -rf node_modules package-lock.json
npm install

# 跳过类型检查启动
npm run dev -- --host
```

### 日志查看

1. **应用日志**
```bash
# 后端日志
tail -f backend/logs/application.log

# Docker 容器日志
docker-compose logs -f backend
```

2. **数据库日志**
```bash
# PostgreSQL 日志
docker-compose logs postgres

# 慢查询日志
docker exec -it agent-postgres psql -U agent_user -d agent_platform -c "SELECT * FROM pg_stat_activity;"
```

## ⚡ 性能优化

### 数据库优化

1. **索引优化**
```sql
-- 为常用查询添加索引
CREATE INDEX idx_documents_knowledge_base_id ON documents(knowledge_base_id);
CREATE INDEX idx_workflows_user_id ON workflows(user_id);
CREATE INDEX idx_mcp_services_status ON mcp_services(status);
```

2. **连接池配置**
```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
```

### 缓存优化

1. **Redis 配置**
```yaml
spring:
  redis:
    timeout: 2000ms
    lettuce:
      pool:
        max-active: 8
        max-idle: 8
        min-idle: 0
```

2. **应用缓存**
```java
@Cacheable(value = "knowledge-bases", key = "#userId")
public List<KnowledgeBase> getUserKnowledgeBases(Long userId) {
    // 实现
}
```

### JVM 优化

```bash
# 生产环境 JVM 参数
export JAVA_OPTS="-Xms2g -Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
mvn spring-boot:run
```

### 前端优化

1. **构建优化**
```javascript
// vite.config.ts
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['react', 'react-dom'],
          antd: ['antd'],
          utils: ['lodash', 'dayjs']
        }
      }
    }
  }
})
```

2. **CDN 配置**
```html
<!-- 使用 CDN 加速 -->
<link rel="dns-prefetch" href="//cdn.jsdelivr.net">
```

## 📊 监控和告警

### 健康检查

1. **应用健康检查**
```bash
# 后端健康检查
curl http://localhost:8080/actuator/health

# 数据库健康检查
curl http://localhost:8080/actuator/health/db
```

2. **服务监控**
```yaml
# docker-compose.yml 添加健康检查
services:
  backend:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
```

### 性能监控

1. **JVM 监控**
```bash
# 启用 JMX
export JAVA_OPTS="$JAVA_OPTS -Dcom.sun.management.jmxremote"
```

2. **数据库监控**
```sql
-- 查看活跃连接
SELECT * FROM pg_stat_activity WHERE state = 'active';

-- 查看慢查询
SELECT query, mean_time, calls FROM pg_stat_statements ORDER BY mean_time DESC LIMIT 10;
```

## 🔒 安全配置

### HTTPS 配置

1. **SSL 证书**
```yaml
server:
  ssl:
    key-store: classpath:keystore.p12
    key-store-password: password
    key-store-type: PKCS12
    key-alias: tomcat
```

2. **反向代理**
```nginx
server {
    listen 443 ssl;
    server_name your-domain.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    location / {
        proxy_pass http://localhost:3000;
    }
    
    location /api {
        proxy_pass http://localhost:8080;
    }
}
```

### 安全头配置

```yaml
spring:
  security:
    headers:
      frame-options: DENY
      content-type-options: nosniff
      xss-protection: 1; mode=block
```

## 📈 扩展部署

### 集群部署

1. **负载均衡**
```yaml
# docker-compose.cluster.yml
services:
  backend:
    deploy:
      replicas: 3
    ports:
      - "8080-8082:8080"
```

2. **数据库集群**
```yaml
services:
  postgres-master:
    image: postgres:15
    environment:
      POSTGRES_REPLICATION_MODE: master
      
  postgres-slave:
    image: postgres:15
    environment:
      POSTGRES_REPLICATION_MODE: slave
      POSTGRES_MASTER_SERVICE: postgres-master
```

### Kubernetes 部署

```yaml
# k8s-deployment.yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: agent-platform-backend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: agent-platform-backend
  template:
    metadata:
      labels:
        app: agent-platform-backend
    spec:
      containers:
      - name: backend
        image: agent-platform-backend:latest
        ports:
        - containerPort: 8080
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
```

---

## 📞 技术支持

如遇到部署问题，请检查：
1. 环境要求是否满足
2. 网络连接是否正常
3. 端口是否被占用
4. 日志中的错误信息

更多技术支持，请参考项目文档或提交 Issue。