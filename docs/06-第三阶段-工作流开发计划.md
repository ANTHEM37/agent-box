# ç¬¬ä¸‰é˜¶æ®µï¼šå·¥ä½œæµåŠŸèƒ½å¼€å‘è®¡åˆ’

## ğŸ¯ ç›®æ ‡æ¦‚è¿°

æ„å»ºä¸€ä¸ªå¯è§†åŒ–çš„å·¥ä½œæµç³»ç»Ÿï¼Œç±»ä¼¼äº Difyï¼Œæ”¯æŒæ‹–æ‹½å¼èŠ‚ç‚¹ç¼–è¾‘ã€å·¥ä½œæµæ‰§è¡Œå¼•æ“å’Œä¸°å¯Œçš„é¢„ç½®èŠ‚ç‚¹ç±»å‹ã€‚

## ğŸ“‹ åŠŸèƒ½æ¸…å•

### 1. å·¥ä½œæµè®¾è®¡å™¨ (Workflow Designer)
- [x] å¯è§†åŒ–ç”»å¸ƒç»„ä»¶
- [x] èŠ‚ç‚¹æ‹–æ‹½å’Œè¿æ¥
- [x] èŠ‚ç‚¹é…ç½®é¢æ¿
- [x] å·¥ä½œæµä¿å­˜å’ŒåŠ è½½
- [x] ç¼©æ”¾å’Œå¹³ç§»åŠŸèƒ½

### 2. å·¥ä½œæµå¼•æ“ (Workflow Engine)
- [x] å·¥ä½œæµè§£æå™¨
- [x] èŠ‚ç‚¹æ‰§è¡Œå™¨
- [x] å˜é‡ä¼ é€’å’Œä¸Šä¸‹æ–‡ç®¡ç†
- [x] æ¡ä»¶åˆ†æ”¯å¤„ç†
- [x] é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

### 3. é¢„ç½®èŠ‚ç‚¹ç±»å‹ (Built-in Node Types)
- [x] **å¼€å§‹èŠ‚ç‚¹** (Start Node)
- [x] **LLM å¯¹è¯èŠ‚ç‚¹** (LLM Chat Node)
- [x] **çŸ¥è¯†åº“æ£€ç´¢èŠ‚ç‚¹** (Knowledge Retrieval Node)
- [x] **HTTP è¯·æ±‚èŠ‚ç‚¹** (HTTP Request Node)
- [x] **æ¡ä»¶åˆ¤æ–­èŠ‚ç‚¹** (Condition Node)
- [x] **å˜é‡è®¾ç½®èŠ‚ç‚¹** (Variable Set Node)
- [x] **ä»£ç æ‰§è¡ŒèŠ‚ç‚¹** (Code Execution Node)
- [x] **ç»“æŸèŠ‚ç‚¹** (End Node)

### 4. å·¥ä½œæµç®¡ç† (Workflow Management)
- [x] å·¥ä½œæµ CRUD æ“ä½œ
- [x] å·¥ä½œæµç‰ˆæœ¬ç®¡ç†
- [x] å·¥ä½œæµåˆ†ç±»å’Œæ ‡ç­¾
- [x] å·¥ä½œæµæ¨¡æ¿åº“

### 5. æ‰§è¡Œç›‘æ§ (Execution Monitoring)
- [x] å®æ—¶æ‰§è¡ŒçŠ¶æ€
- [x] æ‰§è¡Œå†å²è®°å½•
- [x] æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡
- [x] é”™è¯¯æ—¥å¿—è¿½è¸ª

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### åç«¯æ¶æ„
```mermaid
graph TB
    subgraph "å·¥ä½œæµæ¨¡å—"
        A[WorkflowController] --> B[WorkflowService]
        B --> C[WorkflowEngine]
        C --> D[NodeExecutor]
        D --> E[NodeRegistry]
        
        F[ExecutionController] --> G[ExecutionService]
        G --> H[ExecutionMonitor]
        
        I[TemplateController] --> J[TemplateService]
    end
    
    subgraph "èŠ‚ç‚¹ç±»å‹"
        K[StartNode]
        L[LLMChatNode]
        M[KnowledgeRetrievalNode]
        N[HttpRequestNode]
        O[ConditionNode]
        P[VariableSetNode]
        Q[CodeExecutionNode]
        R[EndNode]
    end
    
    subgraph "æ•°æ®å­˜å‚¨"
        S[PostgreSQL<br/>å·¥ä½œæµå®šä¹‰]
        T[Redis<br/>æ‰§è¡ŒçŠ¶æ€]
        U[MongoDB<br/>æ‰§è¡Œæ—¥å¿—]
    end
    
    E --> K
    E --> L
    E --> M
    E --> N
    E --> O
    E --> P
    E --> Q
    E --> R
    
    B --> S
    G --> T
    H --> U
```

### å‰ç«¯æ¶æ„
```mermaid
graph TB
    subgraph "å·¥ä½œæµè®¾è®¡å™¨"
        A[WorkflowCanvas] --> B[NodePalette]
        A --> C[NodeEditor]
        A --> D[ConnectionManager]
        A --> E[CanvasControls]
    end
    
    subgraph "å·¥ä½œæµç®¡ç†"
        F[WorkflowList] --> G[WorkflowForm]
        F --> H[TemplateGallery]
        F --> I[VersionHistory]
    end
    
    subgraph "æ‰§è¡Œç›‘æ§"
        J[ExecutionDashboard] --> K[RealTimeStatus]
        J --> L[ExecutionHistory]
        J --> M[PerformanceMetrics]
    end
    
    subgraph "çŠ¶æ€ç®¡ç†"
        N[WorkflowStore]
        O[ExecutionStore]
        P[NodeStore]
    end
    
    A --> N
    J --> O
    B --> P
```

## ğŸ“Š æ•°æ®æ¨¡å‹è®¾è®¡

### å·¥ä½œæµå®šä¹‰ (Workflow)
```sql
CREATE TABLE workflows (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    definition JSONB NOT NULL,  -- å·¥ä½œæµå›¾ç»“æ„
    version INTEGER DEFAULT 1,
    status VARCHAR(50) DEFAULT 'DRAFT',
    category VARCHAR(100),
    tags TEXT[],
    user_id BIGINT REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### å·¥ä½œæµæ‰§è¡Œ (Workflow Execution)
```sql
CREATE TABLE workflow_executions (
    id BIGSERIAL PRIMARY KEY,
    workflow_id BIGINT REFERENCES workflows(id),
    status VARCHAR(50) DEFAULT 'RUNNING',
    input_data JSONB,
    output_data JSONB,
    context JSONB,  -- æ‰§è¡Œä¸Šä¸‹æ–‡
    started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP,
    error_message TEXT,
    user_id BIGINT REFERENCES users(id)
);
```

### èŠ‚ç‚¹æ‰§è¡Œè®°å½• (Node Execution)
```sql
CREATE TABLE node_executions (
    id BIGSERIAL PRIMARY KEY,
    execution_id BIGINT REFERENCES workflow_executions(id),
    node_id VARCHAR(255) NOT NULL,
    node_type VARCHAR(100) NOT NULL,
    status VARCHAR(50) DEFAULT 'PENDING',
    input_data JSONB,
    output_data JSONB,
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    duration_ms INTEGER,
    error_message TEXT
);
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶å®ç°

### 1. å·¥ä½œæµå¼•æ“æ ¸å¿ƒ
```java
@Service
public class WorkflowEngine {
    
    @Autowired
    private NodeRegistry nodeRegistry;
    
    @Autowired
    private ExecutionService executionService;
    
    public WorkflowExecution executeWorkflow(Long workflowId, Map<String, Object> inputData) {
        // 1. åŠ è½½å·¥ä½œæµå®šä¹‰
        Workflow workflow = workflowService.getById(workflowId);
        
        // 2. åˆ›å»ºæ‰§è¡Œä¸Šä¸‹æ–‡
        ExecutionContext context = new ExecutionContext(inputData);
        
        // 3. å¼€å§‹æ‰§è¡Œ
        WorkflowExecution execution = executionService.startExecution(workflow, context);
        
        // 4. å¼‚æ­¥æ‰§è¡Œå·¥ä½œæµ
        CompletableFuture.runAsync(() -> executeNodes(workflow, execution, context));
        
        return execution;
    }
    
    private void executeNodes(Workflow workflow, WorkflowExecution execution, ExecutionContext context) {
        // å·¥ä½œæµæ‰§è¡Œé€»è¾‘
        WorkflowDefinition definition = workflow.getDefinition();
        Node startNode = findStartNode(definition);
        
        executeNode(startNode, execution, context);
    }
}
```

### 2. èŠ‚ç‚¹æ³¨å†Œå™¨
```java
@Component
public class NodeRegistry {
    
    private final Map<String, NodeExecutor> executors = new HashMap<>();
    
    @PostConstruct
    public void registerNodes() {
        register("start", new StartNodeExecutor());
        register("llm_chat", new LLMChatNodeExecutor());
        register("knowledge_retrieval", new KnowledgeRetrievalNodeExecutor());
        register("http_request", new HttpRequestNodeExecutor());
        register("condition", new ConditionNodeExecutor());
        register("variable_set", new VariableSetNodeExecutor());
        register("code_execution", new CodeExecutionNodeExecutor());
        register("end", new EndNodeExecutor());
    }
    
    public NodeExecutor getExecutor(String nodeType) {
        return executors.get(nodeType);
    }
}
```

### 3. å‰ç«¯å·¥ä½œæµç”»å¸ƒ
```typescript
interface WorkflowCanvasProps {
  workflow: Workflow;
  onWorkflowChange: (workflow: Workflow) => void;
}

export const WorkflowCanvas: React.FC<WorkflowCanvasProps> = ({
  workflow,
  onWorkflowChange
}) => {
  const [nodes, setNodes] = useState<Node[]>(workflow.nodes || []);
  const [edges, setEdges] = useState<Edge[]>(workflow.edges || []);
  
  const onNodesChange = useCallback((changes: NodeChange[]) => {
    setNodes((nds) => applyNodeChanges(changes, nds));
  }, []);
  
  const onEdgesChange = useCallback((changes: EdgeChange[]) => {
    setEdges((eds) => applyEdgeChanges(changes, eds));
  }, []);
  
  const onConnect = useCallback((connection: Connection) => {
    setEdges((eds) => addEdge(connection, eds));
  }, []);
  
  return (
    <div className="workflow-canvas">
      <ReactFlow
        nodes={nodes}
        edges={edges}
        onNodesChange={onNodesChange}
        onEdgesChange={onEdgesChange}
        onConnect={onConnect}
        nodeTypes={nodeTypes}
        edgeTypes={edgeTypes}
        fitView
      >
        <Background />
        <Controls />
        <MiniMap />
      </ReactFlow>
    </div>
  );
};
```

## ğŸ“… å¼€å‘æ—¶é—´çº¿

### ç¬¬1å‘¨ï¼šåŸºç¡€æ¶æ„æ­å»º
- [x] æ•°æ®æ¨¡å‹è®¾è®¡å’Œæ•°æ®åº“è¿ç§»
- [x] å·¥ä½œæµå¼•æ“æ ¸å¿ƒæ¡†æ¶
- [x] èŠ‚ç‚¹æ³¨å†Œå™¨å’ŒåŸºç¡€èŠ‚ç‚¹
- [x] å‰ç«¯å·¥ä½œæµç”»å¸ƒç»„ä»¶

### ç¬¬2å‘¨ï¼šèŠ‚ç‚¹ç±»å‹å®ç°
- [x] LLM å¯¹è¯èŠ‚ç‚¹
- [x] çŸ¥è¯†åº“æ£€ç´¢èŠ‚ç‚¹
- [x] HTTP è¯·æ±‚èŠ‚ç‚¹
- [x] æ¡ä»¶åˆ¤æ–­èŠ‚ç‚¹
- [x] å˜é‡å¤„ç†èŠ‚ç‚¹

### ç¬¬3å‘¨ï¼šç®¡ç†ç•Œé¢å’Œç›‘æ§
- [x] å·¥ä½œæµç®¡ç†ç•Œé¢
- [x] æ‰§è¡Œç›‘æ§é¢æ¿
- [x] æ¨¡æ¿åº“å’Œç‰ˆæœ¬ç®¡ç†
- [x] æ€§èƒ½ä¼˜åŒ–å’Œæµ‹è¯•

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
- èŠ‚ç‚¹æ‰§è¡Œå™¨æµ‹è¯•
- å·¥ä½œæµå¼•æ“æµ‹è¯•
- å‰ç«¯ç»„ä»¶æµ‹è¯•

### é›†æˆæµ‹è¯•
- å®Œæ•´å·¥ä½œæµæ‰§è¡Œæµ‹è¯•
- API æ¥å£æµ‹è¯•
- å‰åç«¯é›†æˆæµ‹è¯•

### æ€§èƒ½æµ‹è¯•
- å¹¶å‘æ‰§è¡Œæµ‹è¯•
- å¤§è§„æ¨¡å·¥ä½œæµæµ‹è¯•
- å†…å­˜å’ŒCPUä½¿ç”¨ç‡æµ‹è¯•

## ğŸš€ éƒ¨ç½²å’Œè¿ç»´

### å®¹å™¨åŒ–éƒ¨ç½²
```yaml
# docker-compose.yml æ›´æ–°
services:
  workflow-engine:
    build: ./backend
    environment:
      - SPRING_PROFILES_ACTIVE=production
      - WORKFLOW_EXECUTOR_THREADS=10
    depends_on:
      - postgres
      - redis
      - mongodb
```

### ç›‘æ§æŒ‡æ ‡
- å·¥ä½œæµæ‰§è¡ŒæˆåŠŸç‡
- å¹³å‡æ‰§è¡Œæ—¶é—´
- èŠ‚ç‚¹æ‰§è¡Œæ€§èƒ½
- ç³»ç»Ÿèµ„æºä½¿ç”¨ç‡

## ğŸ“‹ éªŒæ”¶æ ‡å‡†

1. **åŠŸèƒ½å®Œæ•´æ€§**
   - âœ… æ”¯æŒæ‰€æœ‰é¢„å®šä¹‰èŠ‚ç‚¹ç±»å‹
   - âœ… å·¥ä½œæµå¯è§†åŒ–è®¾è®¡å’Œæ‰§è¡Œ
   - âœ… å®Œæ•´çš„ç®¡ç†å’Œç›‘æ§ç•Œé¢

2. **æ€§èƒ½è¦æ±‚**
   - âœ… æ”¯æŒå¹¶å‘æ‰§è¡Œå¤šä¸ªå·¥ä½œæµ
   - âœ… å•ä¸ªå·¥ä½œæµæ‰§è¡Œæ—¶é—´ < 30ç§’
   - âœ… ç³»ç»Ÿå“åº”æ—¶é—´ < 2ç§’

3. **ç”¨æˆ·ä½“éªŒ**
   - âœ… ç›´è§‚çš„æ‹–æ‹½å¼è®¾è®¡å™¨
   - âœ… å®æ—¶æ‰§è¡ŒçŠ¶æ€åé¦ˆ
   - âœ… è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œæ—¥å¿—

è®©æˆ‘ä»¬å¼€å§‹å®æ–½è¿™ä¸ªè®¡åˆ’ï¼ğŸš€