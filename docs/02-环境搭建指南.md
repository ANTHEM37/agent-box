# 环境搭建指南

## 1. 开发环境要求

### 1.1 基础环境
| 软件 | 版本要求 | 说明 |
|------|----------|------|
| Java | 17+ | 后端开发环境 |
| Node.js | 18+ | 前端开发环境 |
| Maven | 3.8+ | Java 项目构建工具 |
| Docker | 20+ | 容器化部署 |
| Docker Compose | 2.0+ | 多容器编排 |
| Git | 2.30+ | 版本控制 |

### 1.2 IDE 推荐
- **后端开发**: IntelliJ IDEA Ultimate
- **前端开发**: VS Code
- **数据库管理**: DBeaver
- **API 测试**: Postman

## 2. 基础服务搭建

### 2.1 创建 Docker Compose 配置

创建 `docker-compose.yml` 文件：

```yaml
version: '3.8'

services:
  # PostgreSQL 数据库
  postgres:
    image: postgres:15
    container_name: agent-postgres
    environment:
      POSTGRES_DB: agent_platform
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: password
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
      - agent-network
    restart: unless-stopped

  # Redis 缓存
  redis:
    image: redis:7-alpine
    container_name: agent-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - agent-network
    restart: unless-stopped
    command: redis-server --appendonly yes

  # Chroma 向量数据库
  chroma:
    image: chromadb/chroma:latest
    container_name: agent-chroma
    ports:
      - "8000:8000"
    volumes:
      - chroma_data:/chroma/chroma
    environment:
      - CHROMA_SERVER_HOST=0.0.0.0
      - CHROMA_SERVER_HTTP_PORT=8000
    networks:
      - agent-network
    restart: unless-stopped

  # MinIO 对象存储
  minio:
    image: minio/minio:latest
    container_name: agent-minio
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin123
    command: server /data --console-address ":9001"
    networks:
      - agent-network
    restart: unless-stopped

  # RabbitMQ 消息队列
  rabbitmq:
    image: rabbitmq:3.12-management
    container_name: agent-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: password
    networks:
      - agent-network
    restart: unless-stopped

  # Elasticsearch 搜索引擎
  elasticsearch:
    image: elasticsearch:8.11.0
    container_name: agent-elasticsearch
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    networks:
      - agent-network
    restart: unless-stopped

  # Kibana 日志可视化
  kibana:
    image: kibana:8.11.0
    container_name: agent-kibana
    ports:
      - "5601:5601"
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
    depends_on:
      - elasticsearch
    networks:
      - agent-network
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  chroma_data:
  minio_data:
  rabbitmq_data:
  elasticsearch_data:

networks:
  agent-network:
    driver: bridge
```

### 2.2 数据库初始化脚本

创建 `scripts/init-db.sql` 文件：

```sql
-- 创建数据库
CREATE DATABASE agent_platform;

-- 切换到目标数据库
\c agent_platform;

-- 启用 UUID 扩展
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 启用向量扩展（如果使用 pgvector）
-- CREATE EXTENSION IF NOT EXISTS vector;

-- 创建用户表
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(100),
    avatar_url VARCHAR(255),
    status VARCHAR(20) DEFAULT 'ACTIVE',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建知识库表
CREATE TABLE knowledge_bases (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    embedding_model VARCHAR(50) DEFAULT 'text-embedding-ada-002',
    chunk_size INTEGER DEFAULT 500,
    chunk_overlap INTEGER DEFAULT 50,
    status VARCHAR(20) DEFAULT 'ACTIVE',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建文档表
CREATE TABLE documents (
    id BIGSERIAL PRIMARY KEY,
    knowledge_base_id BIGINT NOT NULL REFERENCES knowledge_bases(id),
    filename VARCHAR(255) NOT NULL,
    original_filename VARCHAR(255) NOT NULL,
    content_type VARCHAR(100),
    file_size BIGINT,
    file_path VARCHAR(500),
    status VARCHAR(20) DEFAULT 'PROCESSING',
    error_message TEXT,
    uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    processed_at TIMESTAMP
);

-- 创建文档块表
CREATE TABLE document_chunks (
    id BIGSERIAL PRIMARY KEY,
    document_id BIGINT NOT NULL REFERENCES documents(id),
    chunk_index INTEGER NOT NULL,
    content TEXT NOT NULL,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建工作流表
CREATE TABLE workflows (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    definition JSONB NOT NULL,
    status VARCHAR(20) DEFAULT 'DRAFT',
    version INTEGER DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建工作流执行记录表
CREATE TABLE workflow_executions (
    id BIGSERIAL PRIMARY KEY,
    workflow_id BIGINT NOT NULL REFERENCES workflows(id),
    input_data JSONB,
    output_data JSONB,
    status VARCHAR(20) DEFAULT 'RUNNING',
    error_message TEXT,
    started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP
);

-- 创建 MCP 服务表
CREATE TABLE mcp_services (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    docker_image VARCHAR(255) NOT NULL,
    version VARCHAR(20) NOT NULL,
    pricing_model VARCHAR(20) DEFAULT 'FREE',
    price DECIMAL(10,2) DEFAULT 0.00,
    category VARCHAR(50),
    tags TEXT[],
    status VARCHAR(20) DEFAULT 'PENDING',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建服务调用记录表
CREATE TABLE service_invocations (
    id BIGSERIAL PRIMARY KEY,
    service_id BIGINT NOT NULL REFERENCES mcp_services(id),
    user_id BIGINT NOT NULL REFERENCES users(id),
    input_data JSONB,
    output_data JSONB,
    status VARCHAR(20) DEFAULT 'SUCCESS',
    execution_time INTEGER, -- 毫秒
    cost DECIMAL(10,4) DEFAULT 0.0000,
    invoked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引
CREATE INDEX idx_knowledge_bases_user_id ON knowledge_bases(user_id);
CREATE INDEX idx_documents_knowledge_base_id ON documents(knowledge_base_id);
CREATE INDEX idx_document_chunks_document_id ON document_chunks(document_id);
CREATE INDEX idx_workflows_user_id ON workflows(user_id);
CREATE INDEX idx_workflow_executions_workflow_id ON workflow_executions(workflow_id);
CREATE INDEX idx_mcp_services_user_id ON mcp_services(user_id);
CREATE INDEX idx_service_invocations_service_id ON service_invocations(service_id);
CREATE INDEX idx_service_invocations_user_id ON service_invocations(user_id);

-- 插入测试数据
INSERT INTO users (username, email, password_hash, full_name) VALUES
('admin', 'admin@example.com', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iYqiSfFVMLkxNvuxL7cyGH0B7uWy', '系统管理员'),
('developer', 'dev@example.com', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iYqiSfFVMLkxNvuxL7cyGH0B7uWy', '开发者用户');

COMMIT;
```

### 2.3 启动基础服务

```bash
# 创建项目目录
mkdir -p agent-box/scripts
cd agent-box

# 复制配置文件到项目目录
# 将上面的 docker-compose.yml 和 init-db.sql 放到对应位置

# 启动所有基础服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看服务日志
docker-compose logs -f
```

### 2.4 验证服务启动

```bash
# 验证 PostgreSQL
docker exec -it agent-postgres psql -U admin -d agent_platform -c "SELECT version();"

# 验证 Redis
docker exec -it agent-redis redis-cli ping

# 验证 Chroma
curl http://localhost:8000/api/v1/heartbeat

# 验证 MinIO
curl http://localhost:9000/minio/health/live

# 验证 RabbitMQ
curl http://localhost:15672/api/overview -u admin:password

# 验证 Elasticsearch
curl http://localhost:9200/_cluster/health
```

## 3. 开发工具配置

### 3.1 IntelliJ IDEA 配置

#### 安装必要插件
- Lombok
- Spring Boot Helper
- Database Navigator
- Docker
- Kubernetes

#### 配置代码格式化
1. 导入阿里巴巴 Java 代码规范
2. 配置 Checkstyle
3. 设置自动格式化

#### 配置数据库连接
```
Host: localhost
Port: 5432
Database: agent_platform
Username: admin
Password: password
```

### 3.2 VS Code 配置

#### 安装扩展
```json
{
  "recommendations": [
    "ms-vscode.vscode-typescript-next",
    "bradlc.vscode-tailwindcss",
    "esbenp.prettier-vscode",
    "ms-vscode.vscode-eslint",
    "ms-azuretools.vscode-docker",
    "humao.rest-client"
  ]
}
```

#### 配置 settings.json
```json
{
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  },
  "typescript.preferences.importModuleSpecifier": "relative",
  "emmet.includeLanguages": {
    "typescript": "html",
    "typescriptreact": "html"
  }
}
```

## 4. 环境变量配置

### 4.1 后端环境变量

创建 `backend/.env` 文件：

```properties
# 数据库配置
DB_HOST=localhost
DB_PORT=5432
DB_NAME=agent_platform
DB_USERNAME=admin
DB_PASSWORD=password

# Redis 配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# Chroma 配置
CHROMA_HOST=localhost
CHROMA_PORT=8000

# MinIO 配置
MINIO_ENDPOINT=http://localhost:9000
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin123
MINIO_BUCKET_NAME=agent-platform

# RabbitMQ 配置
RABBITMQ_HOST=localhost
RABBITMQ_PORT=5672
RABBITMQ_USERNAME=admin
RABBITMQ_PASSWORD=password

# JWT 配置
JWT_SECRET=your-secret-key-here
JWT_EXPIRATION=86400000

# OpenAI 配置
OPENAI_API_KEY=your-openai-api-key
OPENAI_BASE_URL=https://api.openai.com/v1

# 应用配置
APP_NAME=AI Agent Platform
APP_VERSION=1.0.0
SERVER_PORT=8080
```

### 4.2 前端环境变量

创建 `frontend/.env` 文件：

```properties
# API 配置
VITE_API_BASE_URL=http://localhost:8080/api
VITE_WS_BASE_URL=ws://localhost:8080/ws

# 应用配置
VITE_APP_NAME=AI Agent Platform
VITE_APP_VERSION=1.0.0

# 第三方服务
VITE_SENTRY_DSN=your-sentry-dsn
VITE_GOOGLE_ANALYTICS_ID=your-ga-id
```

## 5. 开发环境验证

### 5.1 创建验证脚本

创建 `scripts/verify-env.sh` 文件：

```bash
#!/bin/bash

echo "=== 环境验证脚本 ==="

# 检查 Java 版本
echo "检查 Java 版本..."
java -version
if [ $? -ne 0 ]; then
    echo "❌ Java 未安装或版本不符合要求"
    exit 1
fi
echo "✅ Java 版本检查通过"

# 检查 Node.js 版本
echo "检查 Node.js 版本..."
node --version
if [ $? -ne 0 ]; then
    echo "❌ Node.js 未安装或版本不符合要求"
    exit 1
fi
echo "✅ Node.js 版本检查通过"

# 检查 Docker 版本
echo "检查 Docker 版本..."
docker --version
if [ $? -ne 0 ]; then
    echo "❌ Docker 未安装"
    exit 1
fi
echo "✅ Docker 版本检查通过"

# 检查 Docker Compose 版本
echo "检查 Docker Compose 版本..."
docker-compose --version
if [ $? -ne 0 ]; then
    echo "❌ Docker Compose 未安装"
    exit 1
fi
echo "✅ Docker Compose 版本检查通过"

# 检查服务连接
echo "检查数据库连接..."
docker exec agent-postgres pg_isready -U admin -d agent_platform
if [ $? -ne 0 ]; then
    echo "❌ PostgreSQL 连接失败"
    exit 1
fi
echo "✅ PostgreSQL 连接正常"

echo "检查 Redis 连接..."
docker exec agent-redis redis-cli ping > /dev/null
if [ $? -ne 0 ]; then
    echo "❌ Redis 连接失败"
    exit 1
fi
echo "✅ Redis 连接正常"

echo "检查 Chroma 连接..."
curl -s http://localhost:8000/api/v1/heartbeat > /dev/null
if [ $? -ne 0 ]; then
    echo "❌ Chroma 连接失败"
    exit 1
fi
echo "✅ Chroma 连接正常"

echo "检查 MinIO 连接..."
curl -s http://localhost:9000/minio/health/live > /dev/null
if [ $? -ne 0 ]; then
    echo "❌ MinIO 连接失败"
    exit 1
fi
echo "✅ MinIO 连接正常"

echo ""
echo "🎉 所有环境检查通过！可以开始开发了。"
```

### 5.2 运行验证脚本

```bash
# 给脚本执行权限
chmod +x scripts/verify-env.sh

# 运行验证
./scripts/verify-env.sh
```

## 6. 常见问题解决

### 6.1 端口冲突
如果遇到端口冲突，修改 `docker-compose.yml` 中的端口映射：

```yaml
ports:
  - "15432:5432"  # PostgreSQL
  - "16379:6379"  # Redis
  - "18000:8000"  # Chroma
```

### 6.2 权限问题
```bash
# Linux/Mac 下可能需要调整文件权限
sudo chown -R $USER:$USER ./data
chmod -R 755 ./data
```

### 6.3 内存不足
```bash
# 调整 Docker 内存限制
# 在 docker-compose.yml 中添加：
deploy:
  resources:
    limits:
      memory: 512M
```

### 6.4 网络连接问题
```bash
# 重建网络
docker-compose down
docker network prune
docker-compose up -d
```

## 7. 下一步

环境搭建完成后，可以继续进行：

1. [后端开发指南](./03-后端开发指南.md) - 创建 Spring Boot 项目
2. [前端开发指南](./04-前端开发指南.md) - 创建 React 项目
3. [API 设计文档](./06-API设计文档.md) - 了解接口规范

完成环境搭建后，您就可以开始具体的功能开发了！